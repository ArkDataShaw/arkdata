rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================================================
    // Helper Functions
    // ========================================================================

    // Check if the user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Get the user's tenant ID from the auth token
    function userTenantId() {
      return request.auth.token.tenant_id;
    }

    // Get the user's role from the auth token
    function userRole() {
      return request.auth.token.role;
    }

    // Check if the user belongs to the specified tenant
    function isTenantMember(tenantId) {
      return isAuthenticated() && userTenantId() == tenantId;
    }

    // Check if the request comes from a server-side service account
    function isServer() {
      return isAuthenticated()
        && request.auth.token.get('is_service_account', false) == true;
    }

    // Role hierarchy checks
    function isPlatformAdmin() {
      return isAuthenticated() && userRole() == 'platform_admin';
    }

    function isSuperAdmin() {
      return isAuthenticated() && userRole() == 'super_admin';
    }

    // Global admin: platform_admin or super_admin
    function isGlobalAdmin() {
      return isPlatformAdmin() || isSuperAdmin();
    }

    function isTenantAdmin(tenantId) {
      return isTenantMember(tenantId) && userRole() == 'tenant_admin';
    }

    function isAnalyst(tenantId) {
      return isTenantMember(tenantId) && userRole() == 'analyst';
    }

    function isOperator(tenantId) {
      return isTenantMember(tenantId) && userRole() == 'operator';
    }

    function isReadOnly(tenantId) {
      return isTenantMember(tenantId) && userRole() == 'read_only';
    }

    // Combined permission checks
    function canRead(tenantId) {
      return isGlobalAdmin()
        || isTenantAdmin(tenantId)
        || isAnalyst(tenantId)
        || isOperator(tenantId)
        || isReadOnly(tenantId);
    }

    function canWrite(tenantId) {
      return isGlobalAdmin()
        || isTenantAdmin(tenantId);
    }

    function canManageSyncsAndPixels(tenantId) {
      return isGlobalAdmin()
        || isTenantAdmin(tenantId)
        || isOperator(tenantId);
    }

    function canCreateDashboards(tenantId) {
      return isGlobalAdmin()
        || isTenantAdmin(tenantId)
        || isAnalyst(tenantId);
    }

    // ========================================================================
    // Tenants Collection
    // ========================================================================

    match /tenants/{tenantId} {
      // Global admins can read/write ALL tenants (cross-tenant access for admin panel)
      // super_admin can also read child tenants (where parent_tenant_id == their tenant)
      // tenant_admin can read own tenant, update settings
      // all tenant members can read their own tenant
      allow read: if isGlobalAdmin()
        || isTenantMember(tenantId)
        || (isSuperAdmin() && resource.data.parent_tenant_id == userTenantId());
      allow create: if isGlobalAdmin();
      allow update: if isGlobalAdmin() || isTenantAdmin(tenantId);
      allow delete: if isPlatformAdmin();

      // ---- Users sub-collection ----
      match /users/{userId} {
        allow read: if isGlobalAdmin() || canRead(tenantId);
        allow create, update: if isGlobalAdmin() || canWrite(tenantId);
        allow delete: if isGlobalAdmin() || isTenantAdmin(tenantId);
      }

      // ---- Domains (Pixels) sub-collection ----
      match /domains/{domainId} {
        allow read: if isGlobalAdmin() || canRead(tenantId);
        allow create, update: if isGlobalAdmin() || canManageSyncsAndPixels(tenantId);
        allow delete: if isGlobalAdmin() || isTenantAdmin(tenantId);
      }

      // ---- Notifications sub-collection ----
      // Any authenticated user can create notifications for the arkdata tenant
      // (used for cross-tenant feedback notifications to admin)
      match /notifications/{notifId} {
        allow read: if isGlobalAdmin() || canRead(tenantId);
        allow create: if isAuthenticated() && tenantId == 'arkdata';
        allow update, delete: if isGlobalAdmin() || canWrite(tenantId);
      }

      // ---- Onboarding state sub-collection ----
      // Users can read/write their own onboarding state
      match /onboarding_state/{userId} {
        allow read, write: if isAuthenticated()
          && (isGlobalAdmin() || (isTenantMember(tenantId) && request.auth.uid == userId));
      }

      // ---- All other tenant subcollections (catch-all for admin) ----
      match /{subcollection}/{docId} {
        allow read: if isGlobalAdmin() || canRead(tenantId);
        allow write: if isGlobalAdmin() || canWrite(tenantId);
      }
    }

    // ========================================================================
    // Visitors Collection (tenant-scoped)
    // ========================================================================

    match /visitors/{visitorId} {
      // All authenticated tenant members can read visitors
      allow read: if canRead(resource.data.tenant_id);

      // Only server (identity-resolution service) and admins can write
      allow create, update: if isServer()
        || isGlobalAdmin()
        || isTenantAdmin(resource.data.tenant_id);

      allow delete: if isGlobalAdmin()
        || isTenantAdmin(resource.data.tenant_id);
    }

    // ========================================================================
    // Events Collection (tenant-scoped) — append-only, server writes only
    // ========================================================================

    match /events/{eventId} {
      // Authenticated tenant members can read events
      allow read: if canRead(resource.data.tenant_id);

      // ONLY server-side service accounts can write events.
      // No client writes allowed — events originate from pixel-ingest
      // pipeline via Pub/Sub and are written by backend services.
      allow create: if isServer();
      allow update: if isServer();
      allow delete: if isGlobalAdmin();
    }

    // ========================================================================
    // Sessions Collection (tenant-scoped)
    // ========================================================================

    match /sessions/{sessionId} {
      allow read: if canRead(resource.data.tenant_id);

      // Sessions are created/updated by backend services only
      allow create, update: if isServer();
      allow delete: if isGlobalAdmin();
    }

    // ========================================================================
    // Pixels Collection (tenant-scoped)
    // ========================================================================

    match /pixels/{pixelId} {
      allow read: if canRead(resource.data.tenant_id);

      // Operators and admins can manage pixels
      allow create, update: if canManageSyncsAndPixels(resource.data.tenant_id);
      allow delete: if isGlobalAdmin()
        || isTenantAdmin(resource.data.tenant_id);
    }

    // ========================================================================
    // Dashboards Collection (tenant-scoped)
    // ========================================================================

    match /dashboards/{dashboardId} {
      allow read: if canRead(resource.data.tenant_id);

      // Analysts and admins can create and update dashboards
      allow create, update: if canCreateDashboards(resource.data.tenant_id);
      allow delete: if isGlobalAdmin()
        || isTenantAdmin(resource.data.tenant_id);
    }

    // ========================================================================
    // Syncs Collection (tenant-scoped)
    // ========================================================================

    match /syncs/{syncId} {
      allow read: if canRead(resource.data.tenant_id);

      // Operators and admins can manage syncs
      allow create, update: if canManageSyncsAndPixels(resource.data.tenant_id);
      allow delete: if isGlobalAdmin()
        || isTenantAdmin(resource.data.tenant_id);
    }

    // ========================================================================
    // Resolution Log (tenant-scoped) — server-only writes
    // ========================================================================

    match /resolution_log/{logId} {
      allow read: if canRead(resource.data.tenant_id);
      allow create, update: if isServer();
      allow delete: if isGlobalAdmin();
    }

    // ========================================================================
    // Default: deny everything else
    // ========================================================================

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
